**版本要求**：

- 基础库 1.14.0 或更高版本。
- 支付宝客户端 10.1.60 或更高版本。若版本较低，建议做[兼容处理](https://opendocs.alipay.com/mini/framework/compatibility)。
- [小程序开发者工具](https://opendocs.alipay.com/mini/ide/overview) 0.40 或更高版本。

为了满足日益复杂的小程序业务需求，同时提升首次打开速度，支付宝小程序从客户端 10.1.60 版本开始支持分包加载功能。

开发者可以按需将小程序划分为若干个不同的子包。当小程序使用分包功能时，会默认有一个主包，启动页面和 tabBar 所有页面都放在主包中。同时，主包包含了小程序所需的公共资源，例如 JS 脚本等。在服务端构建时，会根据开发者的配置，打成不同的分包。用户在使用小程序进入对应分包的页面时，客户端会下载该分包，并进行解析和渲染。

# 使用建议

- 对于体积较大的小程序项目，建议使用此功能。
- 主包应只保留最常用的核心页面（例如首页、tabBar 页面）和小程序的其它公共资源。不经常使用的页面应放到多个分包中。启动时，只加载主包，并在使用时按需下载分包，避免一次性下载整个代码包，以提升首页启动速度。
- 对于用户经常访问的待跳转页面，尽可能将该页面所在的分包配置为分包预下载，以便提升页面跳转速度。
- 如果小程序由不同团队协作开发，建议使用此功能。
# 使用方法

## 配置方法

典型的分包小程序目录如下：

```javascript
├── app.acss
├── app.js
├── app.json
├── packageA
│   └── pages
│       ├── page1
│       └── page2
├── packageB
│   └── pages
│       ├── page3
│       └── page4
└── pages
    ├── common
    └── index
```

开发者在 `app.json` 文件的 `subPackages` 字段中声明小程序的分包结构：

```json
{
  "pages": ["pages/index", "pages/common"],
  "subPackages": [
    {
      "root": "packageA",
      "pages": ["pages/page1", "pages/page2"]
    },
    {
      "root": "packageB",
      "pages": ["pages/page3", "pages/page4"]
    }
  ]
}
```

`subPackages` 字段的配置说明如下：

| 字段  | 类型        | 说明         |
| ----- | ----------- | ------------ |
| root  | String      | 分包根目录   |
| pages | StringArray | 分包页面路径 |
## 打包与引用原则

- 开发者配置 `subPackages` 后，服务端将按 `subPackages` 配置的路径进行打包，配置路径外的目录默认打包到主包中。
- 启动页面和 tabBar 的所有页面必须放在主包中。
- 每个分包的根目录不能是其他分包的子目录。
- 主包页面路径不能属于任何一个分包的根目录下。
- 分包之间不可引用对方包中的资源（例如图片和 JS 脚本等），分包可以引用主包和自己包内的资源。
- 分包和主包是分别独立打包的，同一 JS 模块在主包和分包中会分别存在。

## 分包大小限制

- 整个小程序所有分包大小不得超过 8 MB。
- 单个分包或主包大小不得超过 2 MB。

**说明**：目前对分包个数无限制。

## 查看当前分包大小

若已完成分包加载配置，可在小程序开发者工具中点击 **详情**，查看小程序当前分包大小。

## 低版本兼容

支付宝服务端构建平台负责处理低版本客户端的兼容问题。服务端会编译打包两份源码包，一份是分包后的代码包，另一份是整包的兼容代码包。支持分包的新客户端使用分包，不支持分包的低版本客户端使用整包。
下面是根据《优秀技术文档的写作标准》修改后的文本：

## 分包预下载

开发者可以通过 `app.json` 里的 `preloadRule` 字段进行配置，在进入小程序某个页面时，由框架自动下载可能需要的分包，以提升分包页面的启动速度。一个典型的分包预加载配置如下：

```json
{
  "pages": ["pages/index"],
  "subPackages": [
    {
      "root": "sub1",
      "pages": ["page1"]
    },
    {
      "root": "sub2",
      "pages": ["page2"]
    },
    {
      "root": "sub3",
      "pages": ["page3"]
    },
    {
      "root": "path/sub4",
      "pages": ["page4"]
    }
  ],
  "preloadRule": {
    "pages/index": {
      "network": "all",
      "packages": ["sub1"]
    },
    "sub1/page1": {
      "packages": ["sub2", "sub3"]
    },
    "sub3/page3": {
      "network": "wifi",
      "packages": ["path/sub4"]
    }
  }
}
```

`preloadRule` 字段中，`key` 是页面路径，`value` 是进入此页面后预下载的配置。每个配置的选项说明如下：

| 字段     | 类型         | 是否必须 | 默认值 | 说明                                       |
| -------- | ------------ | -------- | ------ | ------------------------------------------ |
| packages | StringArray  | 是       | 无     | 进入页面后预下载的分包的 root。             |
| network  | String       | 否       | all    | 在指定网络下进行预下载。<br>all：不限网络。<br>wifi：仅在 wifi 网络下预下载。 |

**注意**：
- `preloadRule` 字段内的 `network` 可以不填，其默认值是 `all`，即不限制网络状态。
- `packages` 内填写的是需要预下载的分包的 root。
- 请确认网络状态与预下载设置相符合，例如，如果设置为 `wifi`，则会仅在 wifi 状态下进行预下载。
# 常见问题

## Q：小程序超过大小限制，应该分包还是减少模块？

A：小程序最大限制是 2MB。如果超过，首先尝试通过代码优化减少包大小，例如将图片资源迁移到服务器。若包大小仍难以控制，可以考虑使用小程序的分包功能。

# 相关文档

[兼容](https://opendocs.alipay.com/mini/framework/compatibility)
