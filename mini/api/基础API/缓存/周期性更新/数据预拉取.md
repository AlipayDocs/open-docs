# 简介
预拉取能够在小程序启动时通过支付宝客户端提前向第三方服务器拉取业务数据，有助于更快地渲染页面，减少用户等待时间。

## 使用限制

- 支付宝客户端 10.2.36 版本，基础库 [2.7.11](https://opendocs.alipay.com/mini/framework/lib-upgrade-v2) 开始支持，低版本需要做 [兼容处理](https://opendocs.alipay.com/mini/framework/compatibility)。
- 此 API 支持个人支付宝小程序、企业支付宝小程序使用。

# 使用流程

## 配置文件
在小程序开发者工具 IDE 根目录创建 preload.json（自研小程序），该文件中填写预拉取配置。<br />**注意：**

- preload.json 最多支持配置 2048 个字节，超过大小 IDE 会提示超限。
- 模板实例化小程序的场景使用 ext 设置（见后面的配置说明）。

![](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/185602/1632191030970-c4309ca7-edad-4f44-8e98-b73a5024b2ab.png#align=left&display=inline&height=313&margin=%5Bobject%20Object%5D&originHeight=313&originWidth=218&status=done&style=none&width=218)

### 属性说明
| **属性** | **类型** | **必填** | **说明** |
| --- | --- | --- | --- |
| fetchType | String | 否 | 请求类型。可选值：pre、jsapiPre。<br />**默认值：** pre |
| params | Object | 是 | 解析配置的请求。 |


#### params 对象属性说明
| **属性** | **类型** | **必填** | **说明** |
| --- | --- | --- | --- |
| url | String | 是 | 请求 URL。 |
| method | String | 否 | HTTP 请求方法。支持 GET、POST、DELETE、PUT。<br />**默认值：** GET <br />**注意：** 当请求方法为 POST、PUT 时，目前发起请求时并未在 query 中追加 appId、timestamp 参数。 |
| headers | Array | 否 | 自定义请求头。<br />默认 {"content-type": "application/json"} 。 |
| dataType | String | 否 | 期望返回的数据格式。支持 JSON、text、base64、arraybuffer。<br />**默认值：** JSON |
| data | Object | 否 | 请求的参数。|


### 配置示例

#### 自研小程序在 preload.json 配置
**注意：** 实际的配置文件不支持注释，下面文件中的注释部分只是为了更好说明每个字段的作用，请在拷贝的时候从配置文件中删除。
```json
[
  {
    "fetchType": "pre",  //配置 pre。
    "params": {
      "url": "https://*****",  // http 请求的 URL 地址。
      "method": "POST", // http method，支持 GET、POST、DELETE、PUT。
      "data": {       //可选。请求的参数，如果是 method 为 GET，会将参数做成 query 拼接在 url 后。
        "foo": "bar"
      },
      "headers": { //可选。额外的 header 信息。
      	"token":"xxx"
      },
      "dataType": "json"   //期望返回的数据格式，默认 JSON，支持 JSON、text、base64、arraybuffer。
    }
  }
]
```

#### 模板小程序实例化时 ext 配置
如果同时在 ext 和 preload.json 配置，会优先读取 ext 的配置，如果 ext 没有配置，则读取 preload.json 的配置。<br />实际的配置文件不支持注释，下面文件中的注释部分只是为了更好说明每个字段的作用，请在拷贝的时候从配置文件中删除。
```json
"preload":
[
  {
    "fetchType": "pre",  //配置 pre。
    "params": {
      "url": "https://*****",  // http 请求的 URL 地址。
      "method": "POST", // http method，支持 GET、POST、DELETE、PUT。
      "data": {       //可选。请求的参数。
        "foo": "bar"
      },
      "headers": { //可选。额外的 header 信息。
      	"token":"xxx"
      },
      "dataType": "json"   //期望返回的数据格式，默认 JSON，支持 JSON、text、base64、arraybuffer。
    }
  }
]
```

## 请求数据
小程序启动时，客户端按配置向目标 URL 发起请求，并在 query string 中自动追加以下参数：

| **参数** | **类型** | **说明** |
| --- | --- | --- |
| appId | String | 小程序的 APPID。 |
| timestamp | Number | 请求发起的时间戳。 |

除上述字段外还包括 preload.json 配置文件中 data 的数据，例如以下参数：

| foo | String | 业务自定义参数，key 和 value 为配置文件中的对应值 {"foo":"bar"}。 |
| --- | --- | --- |

数据请求的 response body 将被缓存，供小程序获取。

## 获取数据
通过调用 JSAPI [my.getBackgroundFetchData](https://opendocs.alipay.com/mini/api/getBackgroundFetchData?pathHash=aee9ff99)  获取预拉取的数据：
```typescript
my.getBackgroundFetchData({
	fetchType: "pre",
  success(res) {
  	console.log(res.fetchedData);
  },
  fail(res) {
  	console.log("getBackgroundFetchData fail: ", res)
  }
})
```
