
# 说明
      一网通办类小程序含有大量H5服务，主文档静态资源（HTML）和其他静态资源（CSS、JS等）的缓存策略会在静态资源变更发布时影响资源的加载，如果静态资源缓存策略不当，会造成变更发版后部分用户业务现场白屏，本方案介绍静态资源缓存技术原理、可能的异常情况及对应的解决方案

# 异常详解

## 新老版本资源同名且主文档与其他静态资源版本不一致

### 错误的技术表现

<br />1. 上一个发版超过10天后，用户有过在线访问，主文档 启发式过期时间 至少大于1天<br />2. 复访时，已经超过1天，JS 等静态资源缓存已经失效<br />3. CDN 对应版本已经删除过

### 具体原因
| **响应头** | **cache-control** | **expires** | **last_modified** | **保鲜寿命** |
| --- | --- | --- | --- | --- |
| 主文档 | NULL | NULL | 发布日期 | **启发式过期时间** |
| 其他资源 | max-age=86400 | 服务端响应时刻+1天 | 发布日期 | **1天** |

如果用户满足以下条件就会产生舆情现场：

- 上次在线请求时，A服务h5资源 **主文档已经发布超过10天**，主文档 启发式过期时间 会超过1天
- 且再次使用时 **超过1天没用 **A服务，导致其他静态资源过期

启发式过期时间：(date - last-modified) * 0.1<br />以上面case为例：([Wed, 03 Feb 2021 11:42:03 GMT] - [Fri, 29 Jan 2021 02:26:50 GMT] ) * 0.1 = 13小时<br />所以解法是：**保持主文档和其他静态资源的版本一致**

### 可选解决方案

1. 主文档响应 主动声明1天缓存（业务出错时没得救）
| **响应头** | **cache-control** | **expires** | **last_modified** | **保鲜寿命** |
| --- | --- | --- | --- | --- |
| 主文档 | **max-age=86400** | - | 发布日期 | **1天** |
| 其他资源 | max-age=86400 | 服务端响应时刻+1天 | 发布日期 | 1天 |


<br />2、不缓存主文档（会导致服务端压力上涨）

| **响应头** | **cache-control** | **expires** | **last_modified** | **保鲜寿命** |
| --- | --- | --- | --- | --- |
| 主文档 | **no-store** | - | 发布日期 | **不保鲜** |
| 其他资源 | max-age=86400 | 服务端响应时刻+1天 | 发布日期 | 1天 |

也即 nginx 配置中，增加以下配置：<br />location /akm-sj-user/index.html {<br />  add_header cache-control no-store<br />}<br />3、每一次静态资源发布时有不同版本控制，新发布时不要撤掉历史版本的静态资源

## 新老版本资源不同名后端接口变化接口名不变

### 错误的技术表现
前端变更切服务端接口变更接口名不变

### 具体原因
老的前端代码请求同名的新服务端接口，造成接口返回相应无法解析，从而无法渲染

### 可选解决方案
新的接口应该重新命名<br />

